# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
orbs:
  heroku: circleci/heroku@1.2.6

jobs:
  build:
    docker:
      - image: 'tghastings/code-esaas'
    steps:
      - checkout
      - run:
          name: rspec
          command: bundle install && bundle exec rake db:migrate RAILS_ENV=test && bundle exec rspec
  deploy:
    executor: heroku/default
    steps:
      - checkout
      - heroku/install
      - heroku/deploy-via-git
  test:
    parallelism: 2
    docker:
      - image: 'tghastings/code-esaas'
    steps:
      - checkout
      - restore_cache:
        keys:
          - portfolio-bundle-
          - portfolio-bundle-
      - run:
          name: Install Bundler Gem
          command: gem install bundler --no-ri --no-rdoc
      - run:
          name: Bundle Install
          command: bundle check || bundle install
      
      # Run rspec in parallel
      - run:
          command: |
            mkdir /tmp/test-results
            TESTFILES=$(circleci tests glob "spec/**/*_spec.rb" | circleci tests split --split-by=timings)
            xvfb-run --auto-servernum bundle exec rspec $TESTFILES --profile 10 --color --format progress --format RspecJunitFormatter --out /tmp/test-results/rspec.xml
      - store_test_results:
          path: /tmp/test-results
      - run:
          name: Stash Coverage Results
          command: |
            mkdir coverage_results
            cp -R coverage/.resultset.json coverage_results/.resultset-${CIRCLE_NODE_INDEX}.json
      - persist_to_workspace:
          root: .
          paths:
            - coverage_results
      - store_artifacts:
          path: tmp/test_prof

  coverage:
    docker:
      - image: ruby:2.1.2
    environment:
      BUNDLE_JOBS: 2
      BUNDLE_RETRY: 3
      BUNDLE_PATH: vendor/bundle
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - portfolio-bundle-
            - portfolio-bundle-
      - run:
          name: Bundle Install
          command: bundle check || bundle install
      - run:
          name: Merge and check coverage
          command: |
            bundle exec rake coverage:report
      - store_artifacts:
          path: coverage



# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  sample: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build
      - deploy:
          requires:
            - build
      - test
      - coverage:
        requires:
          -test